name: Allow Issue Creator to Reopen

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read

jobs:
  reopen-issue:
    if: github.event.issue.state == 'closed'
    runs-on: ubuntu-latest
    outputs:
      zoom_payload: ${{ steps.prepare_payload.outputs.payload }}
      should_notify: ${{ steps.prepare_payload.outputs.should_notify }}
      comment_body: ${{ steps.check_archived.outputs.comment || '' }}
      should_post_comment: ${{ steps.check_archived.outputs.comment != '' }}

    steps:
      - name: Check if comment is a reopen request
        id: check_comment
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          # Truncate to first 10 characters
          COMMENT_PREFIX="${COMMENT_BODY:0:10}"

          if [[ "$COMMENT_PREFIX" == "/reopen"* ]]; then
            echo "is_reopen_request=true" >> $GITHUB_OUTPUT
          else
            echo "is_reopen_request=false" >> $GITHUB_OUTPUT
          fi

      # - name: Check if commenter is issue creator
      #   id: check_creator
      #   if: steps.check_comment.outputs.is_reopen_request == 'true'
      #   run: |
      #     ISSUE_CREATOR="${{ github.event.issue.user.login }}"
      #     COMMENTER="${{ github.event.comment.user.login }}"
      #
      #     if [[ "$ISSUE_CREATOR" == "$COMMENTER" ]]; then
      #       echo "is_creator=true" >> $GITHUB_OUTPUT
      #     else
      #       echo "is_creator=false" >> $GITHUB_OUTPUT
      #       # Set non-creator comment
      #       echo "comment=⚠️ Only the original issue creator can reopen this issue using the \`/reopen\` command. Please ask a maintainer for assistance or create a new issue if needed." >> $GITHUB_OUTPUT
      #     fi

      - name: Check if issue is archived
        id: check_archived
        if: steps.check_comment.outputs.is_reopen_request == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const ARCHIVED_MESSAGE = '⚠️ This issue appears to be archived and has been removed from the project board.\n\nOur team has been notified and will manually restore it before reopening.\n\nPlease allow some time for this to be processed.';

            try {
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });

              // Query project items for this issue
              const result = await github.graphql(`
                query($issueId: ID!) {
                  node(id: $issueId) {
                    ... on Issue {
                      projectItems(first: 10) {
                        nodes {
                          isArchived
                          project {
                            ... on ProjectV2 {
                              number
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `, { issueId: issue.node_id });

              core.info(`GraphQL result: ${JSON.stringify(result, null, 2)}`);

              const node = result.node;

              // Debug: Log all project items
              core.info(`Found ${node.projectItems.nodes.length} project items`);
              node.projectItems.nodes.forEach((item, idx) => {
                core.info(`Project ${idx}: number=${item.project?.number}, isArchived=${item.isArchived}`);
              });

              // Find the project item for project #1
              const projectItem = node.projectItems.nodes.find(
                item => item.project.number === 1
              );

              core.info(`Project item for project #1: ${projectItem ? 'found' : 'not found'}`);
              if (projectItem) {
                core.info(`Project item isArchived: ${projectItem.isArchived}`);
              }

              // If not found on project board OR explicitly archived, treat as archived
              const isArchived = !projectItem || projectItem.isArchived;

              core.setOutput('is_archived', String(isArchived));

              if (isArchived) {
                const reason = !projectItem
                  ? 'Issue not found on project board'
                  : 'Issue is archived on project board';
                core.info(reason);
                core.setOutput('comment', ARCHIVED_MESSAGE);
              } else {
                core.info('Issue is on the project board and not archived');
              }
            } catch (error) {
              core.warning(`Unable to check project status: ${error.message}`);
              core.setOutput('is_archived', 'unknown');
            }

      - name: Prepare Zoom notification payload
        id: prepare_payload
        if: steps.check_comment.outputs.is_reopen_request == 'true' && steps.check_archived.outputs.is_archived == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            const issueTitle = context.payload.issue.title;
            const issueUrl = context.payload.issue.html_url;
            const requester = context.payload.comment.user.login;

            const payload = {
              "Alert": "Archived Issue Reopen Request",
              "Issue": `#${issueNumber}: ${issueTitle}`,
              "Requested by": requester,
              "Action Required": "Manually restore issue to project board, then reopen",
              "URL": issueUrl
            };

            core.setOutput('payload', JSON.stringify(payload));
            core.setOutput('should_notify', 'true');

      - name: Reopen issue
        if: steps.check_comment.outputs.is_reopen_request == 'true' && steps.check_archived.outputs.is_archived != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'open'
            });

            core.info('Issue reopened successfully');

  notify-zoom:
    needs: reopen-issue
    if: needs.reopen-issue.outputs.should_notify == 'true'
    uses: ./.github/workflows/common-notify-zoom.yml
    with:
      payload: ${{ needs.reopen-issue.outputs.zoom_payload }}
    secrets:
      ZOOM_WEBHOOK_URL: ${{ secrets.ZOOM_WEBHOOK_URL }}
      ZOOM_VERIFICATION_TOKEN: ${{ secrets.ZOOM_VERIFICATION_TOKEN }}

  post-comment:
    needs: reopen-issue
    if: needs.reopen-issue.outputs.should_post_comment == 'true'
    uses: ./.github/workflows/common-post-issue-comment.yml
    with:
      issue_number: ${{ github.event.issue.number }}
      comment_body: ${{ needs.reopen-issue.outputs.comment_body }}
