name: Process created issue

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  extract-issue-details:
    if: |
      contains(github.event.issue.body, 'template:01-submit-extension') ||
      contains(github.event.issue.body, 'template:02-submit-update')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      url: ${{ steps.extract.outputs.url }}
      version_number: ${{ steps.extract.outputs.version_number }}
      author: ${{ steps.extract.outputs.author }}
      title: ${{ steps.extract.outputs.title }}
      error_message: ${{ steps.extract.outputs.error_message }}

    steps:
      - name: Extract submission details
        id: extract
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            try {
              const body = context.payload.issue.body || '';
              const EMPTY_RESPONSE = '_No response_';

              // Utility functions
              const sanitizeText = (text, maxLength = 200) => {
                if (!text) return '';
                return text
                  .replace(/[<>\"'`]/g, '')
                  .replace(/[\r\n\t]/g, ' ')
                  .replace(/[^\x20-\x7E]/g, '')
                  .substring(0, maxLength)
                  .trim();
              };

              const validateVersion = (version) => {
                if (!version) return null;
                const trimmed = version.trim();
                if (!/^[0-9a-zA-Z.-]+$/.test(trimmed) || trimmed.length > 50) {
                  throw new Error(`Invalid version format: "${trimmed}". Only alphanumeric characters, dots, and hyphens are allowed.`);
                }
                return trimmed;
              };

              const extractField = (pattern, defaultValue = null) => {
                const match = body.match(pattern);
                return match ? match[1].trim() : defaultValue;
              };

              const isFieldEmpty = (value) => !value || value === EMPTY_RESPONSE;

              const missingFields = [];

              // Extract common fields
              const versionNumber = validateVersion(extractField(/### Version number\s+([^\n]+)/));
              if (isFieldEmpty(versionNumber)) missingFields.push('Version number');
              
              const title = sanitizeText(context.payload.issue.title, 200);
              const author = sanitizeText(extractField(/### Author display name\s+([^\n]+)/), 100);

              core.setOutput('version_number', versionNumber);
              core.setOutput('title', title);
              core.setOutput('author', author);

              let url;
              if (body.includes('template:01-submit-extension')) {
                url = extractField(/### Extension URL\s+([^\s]+)/);
                if (isFieldEmpty(url)) missingFields.push('Extension URL');
                if (isFieldEmpty(author)) missingFields.push('Author display name');
              } else if (body.includes('template:02-submit-update')) {
                url = extractField(/### Pull request URL\s+([^\s]+)/);
                if (isFieldEmpty(url)) missingFields.push('Pull request URL');
                // Author is optional for updates
              }

              core.setOutput('url', url);

              if (missingFields.length > 0) {
                throw new Error(`Missing required fields: ${missingFields.join(', ')}`);
              }
            } catch (error) {
              core.setOutput('error_message', error.message);
              throw error;
            }

  submit-extension:
    needs: extract-issue-details
    if: |
      always() &&
      contains(github.event.issue.body, 'template:01-submit-extension')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      zoom_payload: ${{ steps.prepare_zoom.outputs.payload }}
      comment_body: ${{ steps.prepare_comment.outputs.comment_body }}
      should_close: ${{ steps.prepare_comment.outputs.should_close }}
      has_comment: ${{ steps.prepare_comment.outputs.has_comment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate GitHub repository URL
        id: validate_url
        if: needs.extract-issue-details.outputs.error_message == ''
        continue-on-error: true
        run: |
          if ! python3 .github/scripts/validate_repo_url.py "${{ needs.extract-issue-details.outputs.url }}" new-submission 2>&1 | tee /tmp/validate_error.txt; then
            ERROR_MSG=$(grep -oP '(?<=::error::).*' /tmp/validate_error.txt || echo "Invalid GitHub repository URL format")
            echo "error_message=$ERROR_MSG" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Verify repository exists and is not a fork
        id: validate_repo
        if: needs.extract-issue-details.outputs.error_message == '' && steps.validate_url.outcome == 'success'
        continue-on-error: true
        run: |
          if ! OUTPUT=$(python3 .github/scripts/validate_repo.py 2>&1 | tee /tmp/validate_repo_output.txt); then
            echo "Script failed, extracting error message..."
            cat /tmp/validate_repo_output.txt
            ERROR_MSG=$(grep -oP '(?<=::error::).*' /tmp/validate_repo_output.txt || echo "Repository validation failed")
            echo "Extracted error: $ERROR_MSG"
            echo "error_message=$ERROR_MSG" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Extract normalized_url from script output
          NORMALIZED_URL=$(grep -oP '(?<=normalized_url=).*' /tmp/validate_repo_output.txt)
          echo "normalized_url=$NORMALIZED_URL" >> $GITHUB_OUTPUT
        env:
          URL: ${{ needs.extract-issue-details.outputs.url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Jira ticket
        id: create_jira
        if: needs.extract-issue-details.outputs.error_message == '' && steps.validate_url.outcome == 'success' && steps.validate_repo.outcome == 'success'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const title = process.env.TITLE;
            const issueUrl = context.payload.issue.html_url;

            const jiraAuth = Buffer.from(`${process.env.JIRA_USER_EMAIL}:${process.env.JIRA_API_TOKEN}`).toString('base64');
            const jiraHeaders = { 'Authorization': `Basic ${jiraAuth}`, 'Content-Type': 'application/json' };

            // Create Jira ticket
            const createResponse = await fetch(`${process.env.JIRA_BASE_URL}/rest/api/3/issue`, {
              method: 'POST',
              headers: jiraHeaders,
              body: JSON.stringify({
                fields: {
                  project: { key: process.env.JIRA_PROJECT_KEY },
                  summary: title,
                  issuetype: { id: "10278" },
                  customfield_10932: process.env.NORMALIZED_URL,
                  customfield_12030: "extensions-build-pipeline"
                }
              })
            });

            if (!createResponse.ok) {
              const errorText = await createResponse.text();
              core.warning(`Jira API error: ${createResponse.status} - ${errorText}`);

              throw new Error(`Failed to create Jira ticket: ${createResponse.status}`);
            }

            const jiraIssue = await createResponse.json();
            const jiraKey = jiraIssue.key;
            core.debug(`Created Jira ticket: ${jiraKey}`);

            // Add remote link to GitHub issue
            const linkResponse = await fetch(`${process.env.JIRA_BASE_URL}/rest/api/3/issue/${jiraKey}/remotelink`, {
              method: 'POST',
              headers: jiraHeaders,
              body: JSON.stringify({
                object: {
                  url: issueUrl,
                  title: `GitHub Issue #${context.issue.number}: ${title}`,
                  icon: { url16x16: "https://github.githubassets.com/favicons/favicon.svg", title: "GitHub" }
                }
              })
            });

            if (!linkResponse.ok) {
              const linkErrorText = await linkResponse.text();
              core.warning(`Failed to add remote link: ${linkResponse.status} - ${linkErrorText}`);
            } else {
              core.debug('Added remote link to Jira ticket');
            }

            core.setOutput('jira_url', `${process.env.JIRA_BASE_URL}/browse/${jiraKey}`);
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
          NORMALIZED_URL: ${{ steps.validate_repo.outputs.normalized_url }}
          TITLE: ${{ needs.extract-issue-details.outputs.title }}

      - name: Prepare comment data
        id: prepare_comment
        if: always()
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const extractError = process.env.EXTRACT_ERROR || '';
            const validateUrlOutcome = process.env.VALIDATE_URL_OUTCOME || '';
            const validateRepoOutcome = process.env.VALIDATE_REPO_OUTCOME || '';
            const validateUrlError = process.env.VALIDATE_URL_ERROR || '';
            const validateRepoError = process.env.VALIDATE_REPO_ERROR || '';

            core.info(`Extract error: "${extractError}"`);
            core.info(`Validate URL outcome: "${validateUrlOutcome}"`);
            core.info(`Validate URL error: "${validateUrlError}"`);
            core.info(`Validate repo outcome: "${validateRepoOutcome}"`);
            core.info(`Validate repo error: "${validateRepoError}"`);

            // Job is successful if there are no errors and all outcomes are success
            const jobSuccess = !extractError && validateUrlOutcome === 'success' && validateRepoOutcome === 'success';

            let message;
            let shouldClose = false;

            if (jobSuccess) {
              message = [
                'Thank you for your BApp Store extension submission!',
                '',
                'Your submission has been added to our review queue.',
                '',
                'We will review your extension as soon as possible. You can track the progress of your submission in our [Extension submissions](https://github.com/orgs/PortSwigger/projects/1) project.',
                '',
                'If you have any questions, please comment on this issue. For urgent matters, contact [bapps@portswigger.net](mailto:bapps@portswigger.net). We do not respond to status update requests via email.'
              ].join('\n');
            } else {
              const specificError = extractError || validateUrlError || validateRepoError;
              message = specificError
                ? [
                    '❌ Submission failed.',
                    '',
                    `**Error:** ${specificError}`,
                    '',
                    'Please correct the issue and submit a new request.'
                  ].join('\n')
                : [
                    '❌ Submission failed.',
                    '',
                    'Your submission could not be processed. Please contact [bapps@portswigger.net](mailto:bapps@portswigger.net) for assistance.'
                  ].join('\n');
              shouldClose = true;
            }

            // Use a marker to prevent GitHub from masking the output
            core.setOutput('comment_body', message);
            core.setOutput('should_close', shouldClose.toString());
            core.setOutput('has_comment', 'true');
        env:
          EXTRACT_ERROR: ${{ needs.extract-issue-details.outputs.error_message }}
          VALIDATE_URL_OUTCOME: ${{ steps.validate_url.outcome }}
          VALIDATE_URL_ERROR: ${{ steps.validate_url.outputs.error_message || '' }}
          VALIDATE_REPO_OUTCOME: ${{ steps.validate_repo.outcome }}
          VALIDATE_REPO_ERROR: ${{ steps.validate_repo.outputs.error_message || '' }}

      - name: Prepare Zoom notification payload
        id: prepare_zoom
        if: steps.validate_url.outcome == 'success' && steps.validate_repo.outcome == 'success' && steps.create_jira.outcome == 'success'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const title = process.env.TITLE;
            const jiraUrl = process.env.JIRA_URL;
            const issueUrl = context.payload.issue.html_url;

            const payload = {
              "Extension": title,
              "Jira Ticket": jiraUrl || 'Not created',
              "Issue": issueUrl
            };

            core.setOutput('payload', JSON.stringify(payload));
        env:
          TITLE: ${{ needs.extract-issue-details.outputs.title }}
          JIRA_URL: ${{ steps.create_jira.outputs.jira_url }}

  submit-update:
    needs: extract-issue-details
    if: |
      always() &&
      contains(github.event.issue.body, 'template:02-submit-update')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      zoom_payload: ${{ steps.prepare_zoom.outputs.payload }}
      comment_body: ${{ steps.prepare_comment.outputs.comment_body }}
      should_close: ${{ steps.prepare_comment.outputs.should_close }}
      has_comment: ${{ steps.prepare_comment.outputs.has_comment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate pull request URL
        id: validate_pr
        if: needs.extract-issue-details.outputs.error_message == ''
        continue-on-error: true
        run: |
          if ! python3 .github/scripts/validate_repo_url.py "${{ needs.extract-issue-details.outputs.url }}" 2>&1 | tee /tmp/validate_error.txt; then
            ERROR_MSG=$(grep -oP '(?<=::error::).*' /tmp/validate_error.txt || echo "Invalid pull request URL format")
            echo "error_message=$ERROR_MSG" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Prepare Zoom notification payload
        id: prepare_zoom
        if: steps.validate_pr.outcome == 'success'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const title = process.env.TITLE;
            const prUrl = process.env.URL;
            const versionNumber = process.env.VERSION_NUMBER;
            const issueUrl = context.payload.issue.html_url;

            const payload = {
              "Extension": title,
              "Version": versionNumber,
              "PR": prUrl,
              "Issue": issueUrl,
              "Action": "⚠️ Create associated update ticket."
            };

            core.setOutput('payload', JSON.stringify(payload));
        env:
          URL: ${{ needs.extract-issue-details.outputs.url }}
          VERSION_NUMBER: ${{ needs.extract-issue-details.outputs.version_number }}
          TITLE: ${{ needs.extract-issue-details.outputs.title }}

      - name: Prepare comment data
        id: prepare_comment
        if: always()
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const extractError = process.env.EXTRACT_ERROR || '';
            const validateError = process.env.VALIDATE_ERROR || '';

            // Job is successful if there are no errors
            const jobSuccess = !extractError && !validateError;

            let message;
            let shouldClose = false;

            if (jobSuccess) {
              message = [
                'Thank you for your extension update!',
                '',
                'Your update has been received and our team has been notified.',
                '',
                'We will review your update as soon as possible. You can track the progress in our [Extension submissions](https://github.com/orgs/PortSwigger/projects/1) project.',
                '',
                'If you have any questions, please comment on this issue. For urgent matters, contact [bapps@portswigger.net](mailto:bapps@portswigger.net).'
              ].join('\n');
            } else {
              const specificError = extractError || validateError;
              message = specificError
                ? [
                    '❌ Update submission failed.',
                    '',
                    `**Error:** ${specificError}`,
                    '',
                    'Please correct the issue and submit a new request.'
                  ].join('\n')
                : [
                    '❌ Update submission failed.',
                    '',
                    'Your update could not be processed. Please contact [bapps@portswigger.net](mailto:bapps@portswigger.net) for assistance.'
                  ].join('\n');
              shouldClose = true;
            }

            // Use a marker to prevent GitHub from masking the output
            core.setOutput('comment_body', message);
            core.setOutput('should_close', shouldClose.toString());
            core.setOutput('has_comment', 'true');
        env:
          EXTRACT_ERROR: ${{ needs.extract-issue-details.outputs.error_message }}
          VALIDATE_ERROR: ${{ steps.validate_pr.outputs.error_message }}

  post-comment:
    needs: [extract-issue-details, submit-extension, submit-update]
    if: |
      always() &&
      (needs.submit-extension.outputs.has_comment == 'true' ||
       needs.submit-update.outputs.has_comment == 'true')
    uses: ./.github/workflows/common-post-issue-comment.yml
    with:
      issue_number: ${{ github.event.issue.number }}
      comment_body: ${{ needs.submit-extension.outputs.comment_body || needs.submit-update.outputs.comment_body }}

  close-issue:
    needs: [extract-issue-details, submit-extension, submit-update, post-comment]
    if: |
      always() &&
      needs.post-comment.result == 'success' &&
      (needs.submit-extension.outputs.should_close == 'true' ||
       needs.submit-update.outputs.should_close == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Close issue
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              state_reason: 'not_planned'
            });

  notify-zoom:
    needs: [extract-issue-details, submit-extension, submit-update]
    if: |
      always() &&
      (needs.submit-extension.outputs.zoom_payload != '' ||
       needs.submit-update.outputs.zoom_payload != '')
    uses: ./.github/workflows/common-notify-zoom.yml
    with:
      payload: ${{ needs.submit-extension.outputs.zoom_payload || needs.submit-update.outputs.zoom_payload }}
    secrets:
      ZOOM_WEBHOOK_URL: ${{ secrets.ZOOM_WEBHOOK_URL }}
      ZOOM_VERIFICATION_TOKEN: ${{ secrets.ZOOM_VERIFICATION_TOKEN }}
