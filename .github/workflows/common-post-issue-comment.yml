name: Post Issue Comment

on:
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number to comment on'
        required: true
        type: number
      template_key:
        description: 'Template key (e.g., "extension-submission.success")'
        required: true
        type: string
      error_message:
        description: 'Error message for template substitution'
        required: false
        type: string
        default: ''

permissions:
  issues: write

jobs:
  post-comment:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      TEMPLATE_FILE_PATH: .github/resources/comment-templates.json

    steps:
      - name: Checkout comment templates
        uses: actions/checkout@v4
        with:
          sparse-checkout: ${{ env.TEMPLATE_FILE_PATH }}
          sparse-checkout-cone-mode: false

      - name: Post comment to issue
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const { readFileSync } = require('fs');

            // Load templates and get the specified one
            const templates = JSON.parse(readFileSync(process.env.TEMPLATE_FILE_PATH, 'utf8'));
            const [category, type] = process.env.TEMPLATE_KEY.split('.');
            const template = templates[category]?.[type];

            if (!template) {
              throw new Error(`Template not found: ${process.env.TEMPLATE_KEY}`);
            }

            // Render template with environment variable substitution
            const body = template.replace(/\{\{(\w+)\}\}/g, (_, key) => process.env[key] || '');

            // Post comment
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: parseInt(process.env.ISSUE_NUMBER),
              body
            });

            core.info(`Posted comment to issue #${process.env.ISSUE_NUMBER} using template: ${process.env.TEMPLATE_KEY}`);
        env:
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          TEMPLATE_KEY: ${{ inputs.template_key }}
          ERROR_MESSAGE: ${{ inputs.error_message }}
